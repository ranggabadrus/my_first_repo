<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!DOCTYPE html>
    <html>
      <head>
        <title>ANDESTA</title>
        <style type="text/css">
          .wrap-title,
          .wrap-footer {
            text-align: center;
          }
          .center {
            margin: auto;
            width: 60%;
            padding: 10px;
          }
          #dummyText {
            padding: 50px;
          }
          #btnCreateFile {
            padding: 10px 20px;
            font-size: 15px;
            background: #035369;
            color: #fff;
            border: none;
            cursor: pointer;
          }
          #downloadFile {
            display: inline-block;
            padding: 10px 20px;
            font-size: 15px;
            background: #035369;
            color: #fff;
            border: none;
            cursor: pointer;
            text-decoration: none;
          }
          input {
            border: none;
          }

          input.lama_langganan {
            width: 40px;
          }
        </style>
      </head>
      <body>
        <div class="wrap-title">
          <h2>Welcome to ANDESTA.MY.ID</h2>
        </div>
        <div class="center">
          <form
            name="addtext"
            onsubmit="download(this['lama_langganan'].value, this['user'].value, this['ipv4'].value)"
          >
            <div>
              <b
                >Tanggal register :
                <span id="register"></span>
              </b>
            </div>
            <br />
            <div>
              <b>Lama langganan :</b>
              <input
                id="lama_langganan"
                class="lama_langganan"
                placeholder="..."
                type="number"
              />
              bulan. <span id="expired"></span>
            </div>
            <br />
            <div>
              <b>User (email) :</b> <input id="user" placeholder="..." />
            </div>
            <br />
            <div>
              <b>Ip address :</b>
              <input
                type="text"
                class="form-input"
                id="ipv4"
                name="ipv4"
                placeholder="xxx.xxx.xxx.xxx"
              />
            </div>

            <br />
            <br />

            <input type="submit" onClick="addTexttxt();" value="Generate" />
          </form>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://rawgit.com/RobinHerbots/jquery.inputmask/3.x/dist/jquery.inputmask.bundle.js"></script>

        <script>
          var ipv4_address = $("#ipv4");
          ipv4_address.inputmask({
            alias: "ip",
            greedy: false, //The initial mask shown will be "" instead of "-____".
          });

          var inputExpired = document.getElementById("lama_langganan");
          var langganan = document.getElementById("expired");
          var register = document.getElementById("register");
          var register2 = new Date();
          var register3 =
            register2.getFullYear() +
            "-" +
            (register2.getMonth() + 1) +
            "-" +
            register2.getDate();
          document.getElementById("register").innerHTML = register3;

          const inputHandler = function (e) {
            var date = new Date();

            // console.log("input ", inputExpired);
            var new_date = new Date(
              date.setMonth(date.getMonth() + parseInt(inputExpired.value))
            );

            var date_expired =
              new_date.getFullYear() +
              "-" +
              (new_date.getMonth() + 1) +
              "-" +
              new_date.getDate();

            if (inputExpired.value === "") {
              langganan.innerHTML = "";
            } else {
              langganan.innerHTML = `expire pada <b>${date_expired}</b>.`;
            }
          };

          inputExpired.addEventListener("input", inputHandler);

          function randomPassword(length) {
            var result = "";
            var characters =
              "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
              result += characters.charAt(
                Math.floor(Math.random() * charactersLength)
              );
            }
            return result;
          }

          function download(lama_langganan, user, ip) {
            var tanggal = new Date();

            var tanggal_register =
              tanggal.getFullYear() +
              "-" +
              (tanggal.getMonth() + 1) +
              "-" +
              tanggal.getDate();

            var expired = new Date(
              tanggal.setMonth(tanggal.getMonth() + parseInt(lama_langganan))
            );

            var tanggal_expired =
              expired.getFullYear() +
              "-" +
              (expired.getMonth() + 1) +
              "-" +
              expired.getDate();

            var password_radius = randomPassword(10);
            var pom = document.createElement("a");
            pom.setAttribute(
              "href",
              "data:text/plain;charset=utf-8," +
                encodeURIComponent(`
:log warning "==================================" 
:log warning "ANDESTA.MY.ID CONFIGURATION - START" 
:log warning "==================================" 
:log warning " " 

# VPN CONNECTION 
:log warning ">>> Setting Up VPN Connection ..."
/interface ovpn-client add comment="<<<===|| OVPN – ANDESTA.MY.ID | STATUS: PAID | START: ${tanggal_register} |
EXPIRED: ${tanggal_expired} ||===>>>" connect-to=andesta.my.id name=ovpn-chr-ANDESTA password="${password_radius}" port=1111 profile=default-encryption user="${user}"
:log warning ">>> VPN Connection Setup Complete"

# NAT RULE:log warning ">>> Setting Up NAT Rules ..."/ip firewall nat add disabled="no" action=dst-nat chain=dstnat comment="<<<===|| PORT FORWARD RULE || ANDESTA.MY.ID - 1 ||===>>>" dst-address="${ip}" dst-port="22" protocol=tcp to-ports=80/ip firewall nat add disabled="no" action=dst-nat chain=dstnat comment="<<<===|| PORT FORWARD RULE || ANDESTA.MY.ID - 2 ||===>>>" dst-address="${ip}" dst-port="80" protocol=tcp to-ports=80/ip firewall nat add action=masquerade chain=srcnat comment= "<<<===|| MASQUERADE PORT FORWARD RULE ||===>>>" out-interface=ovpn-chr-andesta:log warning ">>> NAT Rules Setup Complete":log warning " "

# NETWATCH:log warning ">>> Setting Up Netwatch ..."/tool netwatch add comment="<<<===|| NETWATCH –ANDESTA.MY.ID ||===>>>" host=10.20.30.1:log warning ">>> Netwatch Setup Complete"

# RADIUS:log warning ">>> Setting up RADIUS ..."
/radius add comment="<<<===|| RADIUS – ANDESTA.MY.ID ||===>>>" address=10.20.30.1 secret="${password_radius}" service=ppp,hotspot
:log warning ">>> RADIUS Setup Complete"

:log warning " "
:log warning "=================================="
:log warning "ANDESTA.MY.ID CONFIGURATION - END"
:log warning "=================================="
`)
            );
            pom.setAttribute("download", `${user}.txt`);

            pom.style.display = "none";
            document.body.appendChild(pom);

            pom.click();

            document.body.removeChild(pom);
          }

          function addTextHTML() {
            document.addtext.name.value = document.addtext.name.value + ".html";
          }

          function addTextTXT() {
            document.addtext.name.value = document.addtext.name.value + ".txt";
          }
        </script>
      </body>
    </html>
  </body>
</html>
